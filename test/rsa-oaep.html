<!DOCTYPE html>
<html>
  <head>
    <title>RSA-OAEP tests</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="../dist/web-crypto-promise.min.js"></script>
  </head>
  <body>
    <div>RSA-OAEP tests</div>
    <script>
      
      var secret = new Uint8Array([0,1,2,3,4,5,6,7,8,9]);
      var keyPair = {};
      var jwkKeyPair = {};
      var nativeKeyPair = {};
      var polyKeyPair = {};
      var nativeEncrypted;
      var polyEncrypted;
      
      console.log('Secret:');
      console.log(secret);
      
      // Schluessel erstellen
      webCrypto.subtle.generateKey(
        {
          name: "RSA-OAEP",
          modulusLength: 2048,
          publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
          hash: {name: "SHA-256"}
        }, 
        true, 
        ['encrypt', 'decrypt', 'wrapKey', 'unwrapKey']
      ).then(function(result) {
        keyPair = result;
        
        // Export public key to jwk
        return webCrypto.subtle.exportKey("jwk", keyPair.publicKey);
      }).then(function(jwkPub) {
        jwkKeyPair.publicKey = jwkPub;
        
        // Export private key to jwk
        return webCrypto.subtle.exportKey("jwk", keyPair.privateKey);
      }).then(function(jwkPriv) {
        jwkKeyPair.privateKey = jwkPriv;
        
        // Import public key (native)
        return crypto.subtle.importKey(
          "jwk", 
          jwkKeyPair.publicKey,
          {
            name: "RSA-OAEP",
            hash: {name: "SHA-256"}
          }, 
          true, 
          ["encrypt"]);
      }).then(function(key) {
        nativeKeyPair.publicKey = key;
        
        // Import private key (native)
        return crypto.subtle.importKey(
          "jwk", 
          jwkKeyPair.privateKey,
          {
            name: "RSA-OAEP",
            hash: {name: "SHA-256"}
          }, 
          true, 
          ["decrypt"]);
          
      }).then(function(key) {
        nativeKeyPair.privateKey = key;
        
        // Import public key (poly)
        return webCrypto.subtle.importKey(
          "jwk", 
          jwkKeyPair.publicKey,
          {
            name: "RSA-OAEP",
            hash: {name: "SHA-256"}
          }, 
          true, 
          ["encrypt", "wrapKey"]);
        
      }).then(function(key) {
        polyKeyPair.publicKey = key;
        
        // Import private key (poly)
        return webCrypto.subtle.importKey(
          "jwk", 
          jwkKeyPair.privateKey,
          {
            name: "RSA-OAEP",
            hash: {name: "SHA-256"}
          }, 
          true, 
          ["decrypt", "unwrapKey"]);
        
      }).then(function(key) {
        polyKeyPair.privateKey = key;
        
        // Encrypt native
        return crypto.subtle.encrypt(
                {name: "RSA-OAEP"}, nativeKeyPair.publicKey, secret);
      }).then(function(result) {
        nativeEncrypted = result;
      }).then(function() {
        
        // Encrypt Poly
        return webCrypto.subtle.encrypt(
                {name: "RSA-OAEP"}, polyKeyPair.publicKey, secret);
      }).then(function(result) {
        polyEncrypted = result;
      }).then(function() {
        
        // Decrypt native -> native
        return crypto.subtle.decrypt(
                {name: "RSA-OAEP"}, nativeKeyPair.privateKey, nativeEncrypted);
      }).then(function(result) {
        console.log('native encrypted -> native decrypted');
        console.log(new Uint8Array(result));
      }).then(function() {
        
        // Decrypt poly -> poly
        return webCrypto.subtle.decrypt(
                {name: "RSA-OAEP"}, polyKeyPair.privateKey, polyEncrypted);
      }).then(function(result) {
        console.log('poly encrypted -> poly decrypted');
        console.log(new Uint8Array(result));
      }).then(function() {
        
        // Decrypt native -> poly
        return webCrypto.subtle.decrypt(
                {name: "RSA-OAEP"}, polyKeyPair.privateKey, nativeEncrypted);
      }).then(function(result) {
        console.log('native encrypted -> poly decrypted');
        console.log(new Uint8Array(result));
      }).then(function() {
        
        // Decrypt poly -> native
        return crypto.subtle.decrypt(
                {name: "RSA-OAEP"}, nativeKeyPair.privateKey, polyEncrypted);
      }).then(function(result) {
        console.log('poly encrypted -> native decrypted');
        console.log(new Uint8Array(result));
        
        // Generate AES Key
        return webCrypto.subtle.generateKey(
          {
            name: "AES-GCM",
            length: 256
          }, 
          true, 
          ['encrypt', 'decrypt']);
      }).then(function(aesKey) {
        
        console.log('AES-Key:');
        console.log(new Uint8Array(aesKey._handle));
        
        // Wrap AES key
        return webCrypto.subtle.wrapKey(
          "raw",
          aesKey,
          polyKeyPair.publicKey,
          {
            name: "RSA-OAEP",
            hash: {name : "SHA-256"}
          });
      }).then(function(wrappedKey) {
        console.log('wrappedKey:');
        console.log(new Uint8Array(wrappedKey));
        
        // Unwrap AES key
        return webCrypto.subtle.unwrapKey(
          "raw",
          wrappedKey,
          polyKeyPair.privateKey,
          {
            name: "RSA-OAEP",
            modulusLength: 2048,
            publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
            hash: {name: "SHA-256"}
          },
          {
            name: "AES-GCM",
            length: 256
          },
          false,
          ['encrypt', 'decrypt']);
      }).then(function(unwrappedKey) {
        console.log('unwrapped AES key:');
        console.log(new Uint8Array(unwrappedKey._handle));
      }).catch(function(err) {
        console.error(err);
      });
      
    </script>
  </body>
</html>
