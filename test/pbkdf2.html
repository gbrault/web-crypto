<!DOCTYPE html>
<html>
  <head>
    <title>PBKDF2 tests</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="../repos/asmcrypto.js/asmcrypto.js"></script>
    <script type="text/javascript" src="../dist/web-crypto.js"></script>
  </head>
  <body>
    <div>PBKDF2 tests</div>
    <script>
      var password = new Uint8Array([0,1,2,3,4,5,6,7,8,9]);
      var salt = new Uint8Array([0,1,2,3,4,5,6,7,8,9]);
      
      // Generate base key from password
      webCrypto.subtle.importKey(
        'raw',
        password,
        {name: 'PBKDF2'},
        true,
        ['deriveKey']
      ).then(function(baseKey) {
        
        console.log('importedKey: ' + baseKey);
        
        // Derive key
        return webCrypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: salt,
            iterations: 10000,
            hash: {name: 'SHA-256'}
          }, 
          baseKey,
          {
            name: 'AES-GCM',
            length: 256
          },
          true,
          ['encrypt', 'decrypt']
        );
      }).then(function(key) {
        console.log('derivedKey: ' + key);
        return webCrypto.subtle.exportKey('jwk', key);
        
      }).then(function(jwk) {
        console.log('Poly exported key:');
        console.log(jwk);         
        
      }).then(function(jwk) {
        
        // Test shortcut pbkdf2
        return webCrypto.ext.pbkdf2.deriveKeySha256(
          {
            name: 'AES-GCM',
            length: 256
          },
          true,
          ['decrypt', 'encrypt'],
          password,
          salt,
          10000);
        
      }).then(function(key) {
        console.log('Poly derived key (shortcut): ' + key);
        
        return webCrypto.subtle.exportKey('jwk', key);
      }).then(function(jwk) {
        console.log('Poly exported key (shortcut):');
        console.log(jwk);
        
      }).catch(function(err) {
        console.error(err);
      });
    </script>
  </body>
</html>
